<div class="header">
  <h2>Usuarios Registrados ({{ totalUsers }})</h2>
</div>

<div class="create-user-section">
  <h3>Crear nuevo investigador</h3>
  <form (ngSubmit)="crearAdmin()" [formGroup]="nuevoAdminForm" class="create-user-form">
    <div class="form-row">
      <input 
        type="text" 
        formControlName="nombre" 
        placeholder="Nombre completo" 
        [class.error]="nuevoAdminForm.get('nombre')?.invalid && nuevoAdminForm.get('nombre')?.touched" />
      
      <input 
        type="email" 
        formControlName="email" 
        placeholder="Correo electrónico" 
        [class.error]="nuevoAdminForm.get('email')?.invalid && nuevoAdminForm.get('email')?.touched" />
      
      <input 
        type="password" 
        formControlName="password" 
        placeholder="Contraseña (mín. 6 caracteres)" 
        [class.error]="nuevoAdminForm.get('password')?.invalid && nuevoAdminForm.get('password')?.touched" />
      
      <button 
        type="submit" 
        [disabled]="nuevoAdminForm.invalid"
        class="create-btn">
        Crear usuario
      </button>
    </div>
    
    <!-- Mensajes de validación -->
    <div class="validation-errors" *ngIf="nuevoAdminForm.invalid && nuevoAdminForm.touched">
      <small *ngIf="nuevoAdminForm.get('nombre')?.errors?.['required']">El nombre es requerido</small>
      <small *ngIf="nuevoAdminForm.get('nombre')?.errors?.['minlength']">Mínimo 2 caracteres</small>
      <small *ngIf="nuevoAdminForm.get('email')?.errors?.['required']">El email es requerido</small>
      <small *ngIf="nuevoAdminForm.get('email')?.errors?.['email']">Formato de email inválido</small>
      <small *ngIf="nuevoAdminForm.get('password')?.errors?.['required']">La contraseña es requerida</small>
      <small *ngIf="nuevoAdminForm.get('password')?.errors?.['minlength']">Mínimo 6 caracteres</small>
    </div>
  </form>
</div>

<div class="table-container">
  <p-table 
    [value]="users"
    [paginator]="true"
    [rows]="rowsPerPage"
    [first]="first"
    (onPageChange)="onPageChange($event)"
    [loading]="loading"
    responsiveLayout="scroll">

    <!-- ENCABEZADO DE TABLA -->
    <ng-template pTemplate="header">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <!-- CUERPO DE TABLA -->
    <ng-template pTemplate="body" let-user>
      <tr>
        <td>{{ user.usuario_id }}</td>
        <td>
          {{ user.nombre }}
          <span *ngIf="user.usuario_id === currentUserId" class="tu">(tú)</span>
        </td>
        <td>{{ user.email }}</td>
        <td>{{ user.rol?.nombre || 'Sin rol' }}</td>
        <td class="acciones">
          <button 
            pButton 
            label=" Cambiar contraseña" 
            icon="pi pi-key" 
            class="p-button-info p-button-sm"
            (click)="openPasswordDialog(user)">
          </button>

          <button 
            pButton 
            label="Eliminar" 
            icon="pi pi-trash" 
            class="p-button-danger p-button-sm"
            (click)="deleteUser(user.usuario_id)"
            [disabled]="user.usuario_id === currentUserId">
          </button>
        </td>
      </tr>
    </ng-template>

  </p-table>

  <p *ngIf="statusMessage" class="status">{{ statusMessage }}</p>
</div>

<!-- DIÁLOGO PARA CAMBIAR CONTRASEÑA -->
<p-dialog 
  [header]="'Cambiar Contraseña - ' + selectedUserName"
  [(visible)]="showPasswordDialog" 
  [modal]="true" 
  [closable]="true"
  [style]="{ width: '450px' }"
  (onHide)="onPasswordDialogHide()">

  <div class="p-fluid">
    <form [formGroup]="passwordForm">
      <div class="field">
        <label for="newPassword" class="block mb-2">Nueva Contraseña *</label>
        <input 
          type="password" 
          id="newPassword" 
          pInputText 
          formControlName="newPassword"
          placeholder="Mínimo 6 caracteres"
          class="w-full mb-2" 
          [class]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched ? 'ng-invalid ng-dirty' : ''" />
        
        <small *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched" 
               class="error-text">
          La contraseña debe tener al menos 6 caracteres
        </small>
      </div>

      <div class="dialog-buttons">
        <button 
          pButton 
          label="Actualizar" 
          icon="pi pi-check" 
          class="p-button-success" 
          (click)="updatePassword()"
          [disabled]="passwordForm.invalid">
        </button>

        <button 
          pButton 
          label="Cancelar" 
          icon="pi pi-times" 
          class="p-button-secondary" 
          (click)="showPasswordDialog = false">
        </button>
      </div>
    </form>
  </div>
</p-dialog>

<!-- Componente toast para mensajes -->
<p-toast></p-toast>